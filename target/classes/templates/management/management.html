<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poll Management</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <main>
        <h1>Manage Polls</h1>

        <!-- Poll list with inline fragment -->
        <div id="poll-list" th:fragment="poll-list">
            <table>
                <thead>
                    <tr>
                        <th>Question</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="poll : ${polls}">
                        <td th:text="${poll.question}"></td>
                        <td th:text="${#temporals.format(poll.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                        <td class="actions">
                            <a th:href="@{/voting/{id}(id=${poll.id})}" class="btn-link">Vote</a>
                            <a th:href="@{/results/{id}(id=${poll.id})}" class="btn-link">Results</a>
                            <button class="btn-delete"
                                    th:data-delete-url="@{/management/polls/{id}(id=${poll.id})}"
                                    onclick="confirmDelete(event)">
                                Delete
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2>Create New Poll</h2>

        <!-- Create poll form -->
        <form hx-post="/management/polls"
              hx-target="#poll-list"
              hx-swap="outerHTML"
              class="form-create-poll">
            <div class="form-group">
                <label for="question">Question:</label>
                <input type="text" id="question" name="question" placeholder="Poll question" required>
            </div>

            <div class="form-group">
                <label>Options:</label>
                <div id="options-container">
                    <input type="text" name="options[]" placeholder="Option 1" required>
                    <input type="text" name="options[]" placeholder="Option 2" required>
                </div>
            </div>

            <div class="form-actions">
                <button type="button"
                        hx-get="/management/option-input"
                        hx-target="#options-container"
                        hx-swap="beforeend"
                        class="btn-secondary">
                    + Add Option
                </button>
                <button type="submit" class="btn-primary">Create Poll</button>
            </div>
        </form>
    </main>

    <!-- Fragment templates (kept outside the form) -->
    <template>
        <div th:fragment="option-input" class="option-input-wrapper">
            <input type="text" name="options[]" placeholder="Option" required>
            <button type="button"
                    onclick="this.parentElement.remove()"
                    class="btn-delete btn-delete-option"
                    title="Remove this option">
                Ã—
            </button>
        </div>
    </template>

    <!-- Delete confirmation dialog -->
    <dialog id="deleteDialog" class="delete-dialog">
        <div class="dialog-content">
            <h2>Confirm Delete</h2>
            <p id="deleteMessage">Delete this item?</p>
            <div class="dialog-actions">
                <button type="button" onclick="document.getElementById('deleteDialog').close()" class="btn-secondary">
                    Cancel
                </button>
                <button type="button" id="confirmDeleteBtn" class="btn-delete">
                    Delete
                </button>
            </div>
        </div>
    </dialog>

    <script>
        function confirmDelete(event) {
            event.preventDefault();
            const button = event.target;
            const url = button.dataset.deleteUrl;
            const dialog = document.getElementById('deleteDialog');
            const confirmBtn = document.getElementById('confirmDeleteBtn');

            confirmBtn.onclick = () => {
                htmx.ajax('DELETE', url, '#poll-list');
                dialog.close();
            };

            dialog.showModal();
        }
    </script>
</body>
</html>
